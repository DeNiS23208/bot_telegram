# Решение проблемы с webhook от ЮKassa

## Проблема

Webhook'и от ЮKassa не приходят на сервер.

## Причины

1. **DNS не настроен** - домен `xasanim.ru` не указывает на IP сервера `178.72.153.64`
2. **Нет SSL сертификата** - ЮKassa требует HTTPS для webhook
3. **Webhook недоступен извне** - возможно блокировка на уровне провайдера

## Решение

### Шаг 1: Настройка DNS

Убедитесь, что DNS записи для `xasanim.ru` указывают на IP сервера:

```
A запись: xasanim.ru -> 178.72.153.64
```

Проверка DNS:
```bash
dig xasanim.ru +short
# Должно вернуть: 178.72.153.64
```

### Шаг 2: Настройка SSL сертификата

После настройки DNS, установите SSL сертификат:

```bash
ssh root@178.72.153.64

# Замените email на ваш реальный email
certbot --nginx -d xasanim.ru --non-interactive --agree-tos --email your-email@example.com --redirect
```

Или в интерактивном режиме:
```bash
certbot --nginx -d xasanim.ru
```

### Шаг 3: Настройка webhook в ЮKassa

1. Войдите в личный кабинет ЮKassa
2. Перейдите в "Настройки" → "Webhook"
3. Добавьте URL: `https://xasanim.ru/yookassa/webhook`
4. Выберите события:
   - `payment.succeeded`
   - `payment.canceled`
   - `refund.succeeded`

### Шаг 4: Проверка работы

```bash
# Проверка доступности webhook
curl -I https://xasanim.ru/yookassa/webhook

# Проверка логов webhook
ssh root@178.72.153.64 "journalctl -u webhook -f"
```

## Временное решение (для тестирования)

Если DNS еще не настроен, можно временно использовать IP адрес, но **ЮKassa требует HTTPS**, поэтому это не сработает для продакшена.

Для тестирования можно:
1. Использовать ngrok для создания HTTPS туннеля
2. Или настроить самоподписанный сертификат (не рекомендуется для продакшена)

### Использование ngrok (для тестирования)

```bash
# На сервере
apt install ngrok
ngrok http 8000

# Используйте полученный HTTPS URL в ЮKassa
# Например: https://abc123.ngrok.io/yookassa/webhook
```

## Проверка текущего состояния

```bash
# Проверка доступности по IP
curl -I http://178.72.153.64/yookassa/webhook

# Проверка логов
ssh root@178.72.153.64 "journalctl -u webhook -n 50"
```

## Важные замечания

1. **ЮKassa требует HTTPS** - без SSL сертификата webhook не будет работать
2. **DNS должен быть настроен** - домен должен указывать на IP сервера
3. **Порты 80 и 443 должны быть открыты** - проверьте настройки файрвола в панели управления облачного провайдера

## Текущий статус

- ✅ Webhook работает локально (порт 8000)
- ✅ Nginx настроен и работает (порт 80)
- ❌ DNS не настроен или не резолвится
- ❌ SSL сертификат не установлен
- ❌ HTTPS недоступен

## Следующие шаги

1. Настройте DNS для `xasanim.ru` на IP `178.72.153.64`
2. Установите SSL сертификат через certbot
3. Настройте webhook в личном кабинете ЮKassa
4. Проверьте работу через тестовый платеж

