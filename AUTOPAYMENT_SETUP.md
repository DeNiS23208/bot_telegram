# Настройка автоплатежей в ЮKassa

## Текущая ситуация

Бот настроен для работы с автоплатежами, но ваш магазин в ЮKassa еще не настроен для приема автоплатежей.

## Что нужно сделать

### 1. Обратиться к менеджеру ЮKassa

**Важно:** По умолчанию автоплатежи работают только в тестовом магазине. Для реального магазина нужно обратиться к менеджеру ЮKassa.

**Что нужно сообщить менеджеру:**
- Вы хотите использовать автоплатежи для автоматического продления подписок
- Нужно настроить магазин для приема автоплатежей
- Планируете использовать условное сохранение способа оплаты (пользователь сам решает на форме оплаты)

### 2. После настройки магазина

Когда менеджер ЮKassa настроит ваш магазин для автоплатежей:

1. **Автоматически заработает:**
   - При оплате пользователю будет предлагаться сохранить способ оплаты (если оплата картой или через ЮMoney)
   - Если пользователь согласится, способ оплаты будет сохранен
   - В webhook будет приходить `payment_method_id` для сохраненных способов оплаты

2. **Автопродление:**
   - Пользователь сможет включить автопродление через кнопку в боте
   - При истечении подписки будет автоматически создаваться платеж с сохраненным способом оплаты
   - Деньги будут списываться автоматически без участия пользователя

## Как это работает сейчас

### До настройки магазина:
- ✅ Бот работает нормально
- ✅ Платежи создаются и обрабатываются
- ❌ Сохранение способа оплаты не работает (магазин не настроен)
- ❌ Автопродление показывает сообщение, но фактически не работает

### После настройки магазина:
- ✅ Все функции работают автоматически
- ✅ Пользователи смогут сохранять способы оплаты
- ✅ Автопродление будет работать полностью автоматически

## Текущая реализация в коде

Код уже готов к работе с автоплатежами:

1. **payments.py** - пытается использовать `save_payment_method`, но если магазин не настроен, создает платеж без этого параметра
2. **webhook_app.py** - проверяет и сохраняет `payment_method_id` если способ оплаты был сохранен
3. **bot.py** - кнопка автопродления проверяет наличие сохраненного способа оплаты
4. **db.py** - хранит `saved_payment_method_id` и статус автопродления

## Что делать дальше

1. **Сейчас:** Бот работает, можно принимать платежи
2. **Обратиться к менеджеру ЮKassa:** Настроить магазин для автоплатежей
3. **После настройки:** Все функции автопродления заработают автоматически

## Дополнительная информация

Согласно документации ЮKassa:
- Если магазин настроен для автоплатежей, пользователю автоматически будет предлагаться сохранить способ оплаты при оплате картой или через ЮMoney
- Можно использовать как безусловное (автоматическое), так и условное (по желанию пользователя) сохранение
- После сохранения способа оплаты можно использовать его для автоматических списаний

