# Безопасность автоматической очистки данных

## ⚠️ ВАЖНО: Активные пользователи и подписки НЕ удаляются!

Автоматическая очистка **НЕ ТРОГАЕТ**:
- ✅ **Пользователей** (таблица `users`) - НЕ удаляется
- ✅ **Подписки** (таблица `subscriptions`) - НЕ удаляется
- ✅ **Активные платежи** (статус `succeeded` или `pending`) - НЕ удаляются
- ✅ **Активные invite links** (не отозванные) - НЕ удаляются

## Что удаляется при автоматической очистке:

### 1. Старые неудачные/отмененные платежи (старше 90 дней)
```sql
DELETE FROM payments 
WHERE created_at < ? AND status NOT IN ('succeeded', 'pending')
```

**Удаляются ТОЛЬКО:**
- Платежи со статусом `canceled`, `failed`, `expired` и т.д.
- Которые старше 90 дней
- **НЕ удаляются:** успешные платежи (`succeeded`) и ожидающие (`pending`)

**Почему это безопасно:**
- Успешные платежи сохраняются навсегда (для истории и отчетов)
- Ожидающие платежи не удаляются (могут быть оплачены позже)
- Удаляются только отмененные/неудачные платежи, которые уже не нужны

### 2. Старые отозванные invite links (старше 180 дней)
```sql
DELETE FROM invite_links 
WHERE revoked = 1 AND created_at < ?
```

**Удаляются ТОЛЬКО:**
- Ссылки, которые были отозваны (`revoked = 1`)
- Которые старше 180 дней
- **НЕ удаляются:** активные ссылки (которые еще работают)

**Почему это безопасно:**
- Активные ссылки (которые пользователи используют) НЕ удаляются
- Удаляются только старые отозванные ссылки, которые уже не нужны
- Это освобождает место в БД без вреда для пользователей

### 3. Старые записи processed_payments (старше 90 дней)
```sql
DELETE FROM processed_payments WHERE processed_at < ?
```

**Удаляются ТОЛЬКО:**
- Записи о том, что платеж был обработан
- Которые старше 90 дней
- Это служебная таблица для предотвращения дублирования обработки

**Почему это безопасно:**
- Это только служебные записи, не влияющие на пользователей
- После 90 дней они уже не нужны (платеж точно обработан)

## Что НИКОГДА не удаляется автоматически:

### ❌ Пользователи (users)
- Таблица `users` **НЕ ТРОГАЕТСЯ** автоматической очисткой
- Все пользователи остаются в базе навсегда
- Это нужно для истории и аналитики

### ❌ Подписки (subscriptions)
- Таблица `subscriptions` **НЕ ТРОГАЕТСЯ** автоматической очисткой
- Все подписки (активные и истекшие) остаются в базе
- Это критически важно - пользователь не потеряет свою подписку!

### ❌ Успешные платежи (payments со статусом succeeded)
- Успешные платежи **НЕ УДАЛЯЮТСЯ** никогда
- Они нужны для истории, отчетов и аналитики
- Пользователь всегда может увидеть историю своих платежей

### ❌ Активные invite links
- Активные (не отозванные) ссылки **НЕ УДАЛЯЮТСЯ**
- Пользователь может использовать свою ссылку в любое время

## Как это работает:

### Расписание очистки:
- Запускается **один раз в день** (через 24 часа)
- Первый запуск через 1 час после старта бота
- При ошибке - повтор через 6 часов

### Логика безопасности:
1. **Проверка статуса** - удаляются только неактуальные данные
2. **Проверка возраста** - удаляются только старые данные (90-180 дней)
3. **Защита активных данных** - активные подписки и платежи защищены условиями WHERE

## Примеры:

### ✅ Безопасно (НЕ удалится):
- Пользователь с активной подпиской (expires_at в будущем)
- Пользователь с истекшей подпиской (остается в БД для истории)
- Успешный платеж от 6 месяцев назад (статус `succeeded`)
- Активная invite link (не отозвана)

### ✅ Удалится (безопасно):
- Отмененный платеж от 4 месяцев назад (статус `canceled`, старше 90 дней)
- Отозванная invite link от 7 месяцев назад (revoked=1, старше 180 дней)
- Служебная запись processed_payment от 4 месяцев назад

## Гарантии безопасности:

1. **Подписки защищены** - таблица `subscriptions` не трогается
2. **Пользователи защищены** - таблица `users` не трогается
3. **Успешные платежи защищены** - условие `status NOT IN ('succeeded', 'pending')`
4. **Активные ссылки защищены** - условие `revoked = 1`

## Вывод:

**Автоматическая очистка БЕЗОПАСНА для пользователей:**
- ✅ Пользователь, который купил подписку, **НЕ ПОТЕРЯЕТ** её
- ✅ Его данные **НЕ БУДУТ УДАЛЕНЫ**
- ✅ Его платежи **НЕ БУДУТ УДАЛЕНЫ**
- ✅ Его активная ссылка **НЕ БУДЕТ УДАЛЕНА**

Очистка удаляет только:
- Старые отмененные платежи (которые уже не нужны)
- Старые отозванные ссылки (которые уже не работают)
- Служебные записи (которые уже не используются)

**Пользователь НЕ МОЖЕТ быть случайно удален из-за фоновых процессов!**

