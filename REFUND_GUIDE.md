# Руководство по возвратам средств

## Обзор

Бот поддерживает возвраты средств для **всех типов платежей**:
- ✅ Банковская карта
- ✅ SberPay
- ✅ СБП (Система быстрых платежей)

## Автоматическая обработка возвратов

При создании возврата через API ЮKassa, бот автоматически:
1. Получает webhook `refund.succeeded` от ЮKassa
2. Отменяет подписку пользователя
3. Удаляет пользователя из списка одобренных
4. Отправляет уведомление пользователю о возврате

## Создание возврата вручную

### Через скрипт

```bash
# Полный возврат (вся сумма платежа)
python3 create_refund.py <payment_id>

# Частичный возврат
python3 create_refund.py <payment_id> <amount>

# Возврат с описанием
python3 create_refund.py <payment_id> <amount> "Описание возврата"
```

### Через Python код

```python
from payments import create_refund

# Полный возврат
refund_id, status = create_refund(
    payment_id="2c8d8c8e-0001-5000-8000-000000000000"
)

# Частичный возврат
refund_id, status = create_refund(
    payment_id="2c8d8c8e-0001-5000-8000-000000000000",
    amount_rub="500.00",
    description="Возврат по запросу клиента"
)
```

## Важные моменты

1. **Возврат можно создать только для успешных платежей** (status = `succeeded`)
2. **Возврат работает для всех типов платежей** - SberPay, СБП, банковская карта
3. **Срок возврата средств**: несколько рабочих дней (зависит от банка)
4. **При возврате подписка автоматически отменяется** - пользователь теряет доступ к каналу

## Получение payment_id

Payment_id можно найти:
- В логах бота при создании платежа
- В базе данных в таблице `payments`
- В личном кабинете ЮKassa
- В Excel отчете (если включен)

## Проверка статуса возврата

```python
from payments import get_refund_status

status = get_refund_status(refund_id)
print(f"Статус возврата: {status}")
```

Возможные статусы:
- `pending` - возврат создан, ожидает обработки
- `succeeded` - возврат успешно выполнен
- `canceled` - возврат отменен

## Логирование

Все операции с возвратами логируются в файл логов бота:
- Создание возврата
- Получение webhook'ов от ЮKassa
- Отмена подписки пользователя
- Отправка уведомлений

## Поддержка

При возникновении проблем:
1. Проверьте логи бота
2. Проверьте статус платежа в ЮKassa
3. Убедитесь, что платеж имеет статус `succeeded`
4. Обратитесь к документации ЮKassa: https://yookassa.ru/developers/api#refund

